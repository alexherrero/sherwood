name: Auto Release

on:
  schedule:
    # Runs at 16:00 UTC every Monday (08:00 AM PST / 09:00 AM PDT)
    - cron: "0 16 * * 1"
  workflow_dispatch:

jobs:
  build-and-release:
    name: Build & Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read # Required to list workflow runs

    steps:
      - name: Find Last Green Backend Commit
        id: green_commit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find the latest successful run of 'backend.yml' on 'main'
          # We search for the most recent run with status='success'
          LAST_GREEN_SHA=$(gh run list --workflow backend.yml --repo ${{ github.repository }} --branch main --status success --limit 1 --json headSha --jq '.[0].headSha')

          if [ -z "$LAST_GREEN_SHA" ] || [ "$LAST_GREEN_SHA" == "null" ]; then
            echo "::error::No successful backend runs found. Exiting."
            exit 1
          fi

          echo "Found last green commit: $LAST_GREEN_SHA"
          echo "sha=$LAST_GREEN_SHA" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.green_commit.outputs.sha }}
          fetch-depth: 0 # Important: Fetch all history for tags

      - name: Commit Details
        run: |
          echo "## ðŸš€ Release Commit" >> $GITHUB_STEP_SUMMARY

          COMMIT_HASH=$(git log -1 --format="%h")
          COMMIT_DATE=$(git log -1 --format="%cd" --date=format:'%Y-%m-%d %H:%M:%S')
          COMMIT_MSG=$(git log -1 --format="%s")
          COMMIT_AUTHOR=$(git log -1 --format="%an")

          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`$COMMIT_HASH\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Date** | $COMMIT_DATE |" >> $GITHUB_STEP_SUMMARY
          echo "| **Author** | $COMMIT_AUTHOR |" >> $GITHUB_STEP_SUMMARY
          echo "| **Message** | $COMMIT_MSG |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Code Statistics
        run: |
          sudo apt-get update && sudo apt-get install -y cloc

          # Run cloc, excluding vendor/generated dirs
          cloc --json --out=cloc.json --exclude-dir=vendor,node_modules,.github .

          TOTAL_LOC=$(jq '.SUM.code' cloc.json)
          TOTAL_FILES=$(jq '.SUM.nFiles' cloc.json)

          echo "## ðŸ“Š Code Statistics" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :---: |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Lines of Code** | **$TOTAL_LOC** |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Files** | **$TOTAL_FILES** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Language Breakdown" >> $GITHUB_STEP_SUMMARY
          echo '```mermaid' >> $GITHUB_STEP_SUMMARY
          echo 'pie showData' >> $GITHUB_STEP_SUMMARY
          echo '    title LOC by Language' >> $GITHUB_STEP_SUMMARY

          # Parse JSON: remove header/SUM, sort by LOC desc, take top 10, format for Mermaid
          jq -r 'del(.header, .SUM) | to_entries | sort_by(.value.code) | reverse | .[:10] | .[] | "    \"\(.key)\" : \(.value.code)"' cloc.json >> $GITHUB_STEP_SUMMARY

          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Install dependencies
        run: go mod download

      # Build Linux Binary
      # Using CGO_ENABLED=0 for static binaries (modernc.org/sqlite supports this)
      - name: Build Linux Binary
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o sherwood-linux-amd64 ./backend/main.go

      # Build Windows Binary
      - name: Build Windows Binary
        run: |
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o sherwood-windows-amd64.exe ./backend/main.go

      - name: Determine Version
        id: version
        # Run bash logic to find the next release number for today
        run: |
          DATE=$(date +'%Y.%m.%d')
          # List tags matching today's date pattern: YYYY.MM.DD-*
          # Note: If no tags exist, grep might fail, so we handle it gracefully or check variable
          EXISTING_TAGS=$(git tag --list "$DATE-*")

          if [ -z "$EXISTING_TAGS" ]; then
            NEXT_NUM=1
          else
            # Extract the suffix number, sort numerically descending, take the top one
            LAST_NUM=$(echo "$EXISTING_TAGS" | sed "s/^$DATE-//" | sort -rn | head -n 1)
            # Check if LAST_NUM is a valid integer (in case of weird tags), default to 0 if empty
            if [[ ! "$LAST_NUM" =~ ^[0-9]+$ ]]; then LAST_NUM=0; fi
            NEXT_NUM=$((LAST_NUM + 1))
          fi

          NEW_TAG="$DATE-$NEXT_NUM"
          echo "Calculated new tag: $NEW_TAG"
          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: Generate Changelog
        id: changelog
        run: |
          # Get the latest tag securely (suppress error if no tags exist)
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "## Initial Release" > release_notes.md
            git log --pretty=format:"- %s (%h)" >> release_notes.md
          else
            echo "## Changes since $PREV_TAG" > release_notes.md
            git log --pretty=format:"- %s (%h)" "$PREV_TAG..HEAD" >> release_notes.md
          fi

          # Cat the file to output for debugging
          cat release_notes.md

      # Create Release with auto-generated notes and custom changelog
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: AutoRelease ${{ steps.version.outputs.tag }}
          tag_name: ${{ steps.version.outputs.tag }}
          body_path: release_notes.md
          files: |
            sherwood-linux-amd64
            sherwood-windows-amd64.exe
          draft: false
          prerelease: false
