name: Backend

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "**" ]

jobs:
  build-and-test:
    name: Build and Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25.7' # Matching the project's Go version requirement or latest stable

    - name: Install dependencies
      working-directory: ./
      run: go mod download

    - name: Run Tests
      working-directory: ./
      shell: bash
      run: |
        set +e
        go test -v ./... > test_output.txt 2>&1
        TEST_EXIT_CODE=$?
        set -e
        
        cat test_output.txt
        
        TOTAL=$(grep -c -E "^\s*=== RUN" test_output.txt || true)
        PASS=$(grep -c -E "^\s*--- PASS:" test_output.txt || true)
        FAIL=$(grep -c -E "^\s*--- FAIL:" test_output.txt || true)
        SKIP=$(grep -c -E "^\s*--- SKIP:" test_output.txt || true)
        
        echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Tests | Count |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :---: |" >> $GITHUB_STEP_SUMMARY
        echo "| Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
        echo "| Passed | $PASS |" >> $GITHUB_STEP_SUMMARY
        echo "| Failed | $FAIL |" >> $GITHUB_STEP_SUMMARY
        echo "| Skipped | $SKIP |" >> $GITHUB_STEP_SUMMARY
        
        if [ $TEST_EXIT_CODE -ne 0 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ❌ Failures" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          grep -E "^--- FAIL:|FAIL|panic:|[a-zA-Z0-9_]+\.go:[0-9]+:" test_output.txt | grep -v "PASS:" || true >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          exit $TEST_EXIT_CODE
        fi

    - name: Build
      working-directory: ./
      run: go build -v ./backend/...

  integration-test:
    name: Integration Test - Order Persistence
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25.7'

    - name: Install dependencies
      run: go mod download

    - name: Build backend
      run: go build -o sherwood ./backend/main.go

    - name: Run Order Persistence Tests
      shell: bash
      run: |
        set -o pipefail
        {
          # Create test config
          cat > .env << EOF
        PORT=8099
        HOST=127.0.0.1
        API_KEY=test-key-12345
        TRADING_MODE=dry_run
        DATABASE_PATH=./data/test_persistence.db
        LOG_LEVEL=info
        DATA_PROVIDER=yahoo
        ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8099
        ENABLED_STRATEGIES=ma_crossover
        EOF

          # Start server (first run)
          ./sherwood &
          SERVER_PID=$!
          echo $SERVER_PID > server.pid
          echo "Server started with PID: $SERVER_PID"
          sleep 5

          # Verify server is running
          echo "Verifying Health Endpoint..."
          curl --retry 5 --retry-delay 2 --retry-connrefused http://127.0.0.1:8099/health
          echo "✅ Health check passed"

          # Submit test order
          echo "Submitting Order..."
          RESPONSE=$(curl -s -X POST http://127.0.0.1:8099/api/v1/execution/orders \
            -H "Content-Type: application/json" \
            -H "X-Sherwood-API-Key: test-key-12345" \
            -d '{"symbol":"BTC-USD","side":"buy","type":"limit","quantity":0.01,"price":50000.00}')
          echo "Order response: $RESPONSE"
          ORDER_ID=$(echo $RESPONSE | jq -r '.id')
          
          if [ -z "$ORDER_ID" ] || [ "$ORDER_ID" = "null" ]; then
            echo "✗ Failed to submit order"
            kill $SERVER_PID
            exit 1
          fi
          echo "✅ Submitted order: $ORDER_ID"

          # Stop server
          echo "Stopping server..."
          kill $SERVER_PID || true
          sleep 2

          # Verify database file exists
          if [ ! -f ./data/test_persistence.db ]; then
            echo "✗ Database file not found!"
            exit 1
          fi
          echo "✅ Database file exists"

          # Restart server (second run)
          echo "Restarting server..."
          ./sherwood &
          SERVER_PID=$!
          echo $SERVER_PID > server2.pid
          sleep 5

          # Verify server restarted
          curl --retry 5 --retry-delay 2 --retry-connrefused http://127.0.0.1:8099/health
          echo "✅ Health check passed after restart"

          # Verify order persisted
          echo "Checking for order: $ORDER_ID"
          RESPONSE=$(curl -s http://127.0.0.1:8099/api/v1/execution/orders \
            -H "X-Sherwood-API-Key: test-key-12345")
          
          RETRIEVED_ID=$(echo $RESPONSE | jq -r ".orders[] | select(.id==\"$ORDER_ID\") | .id")
          if [ "$RETRIEVED_ID" != "$ORDER_ID" ]; then
            echo "✗ Order not found after restart! Expected: $ORDER_ID"
            kill $SERVER_PID
            exit 1
          fi
          echo "✅ Order successfully persisted across restart!"

          # Verify trade history
          RESPONSE=$(curl -s http://127.0.0.1:8099/api/v1/execution/trades \
            -H "X-Sherwood-API-Key: test-key-12345")
          if echo "$RESPONSE" | grep -q "error"; then
            echo "✗ Failed to fetch trades"
            kill $SERVER_PID
            exit 1
          fi
          echo "✅ Trade history endpoint functional"

          # Verify order modification
          RESPONSE=$(curl -s -X POST http://127.0.0.1:8099/api/v1/execution/orders \
            -H "Content-Type: application/json" \
            -H "X-Sherwood-API-Key: test-key-12345" \
            -d '{"symbol":"ETH-USD","side":"buy","type":"limit","quantity":1.0,"price":3000.00}')
          MOD_ORDER_ID=$(echo $RESPONSE | jq -r '.id')
          MOD_RESPONSE=$(curl -s -X PATCH http://127.0.0.1:8099/api/v1/execution/orders/$MOD_ORDER_ID \
            -H "Content-Type: application/json" \
            -H "X-Sherwood-API-Key: test-key-12345" \
            -d '{"price": 3100.00}')
          NEW_PRICE=$(echo $MOD_RESPONSE | jq -r '.price')
          if [ "$NEW_PRICE" != "3100" ]; then
            echo "✗ Order modification failed!"
            kill $SERVER_PID
            exit 1
          fi
          echo "✅ Order modification verified"

          # Cleanup
          kill $SERVER_PID || true
          rm -f ./data/test_persistence.db
        } 2>&1 | tee persistence_output.txt

    - name: Run API & Config Tests
      shell: bash
      run: |
        set -o pipefail
        {
          # Start with API key
          API_KEY=test-ci-key ./sherwood &
          SERVER_PID=$!
          sleep 5

          # Verify Historical Data (Simulate Failure/Ignored)
          echo "Verifying History Endpoint..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-Sherwood-API-Key: test-ci-key" "http://localhost:8099/api/v1/data/history?symbol=SPY&interval=1d")
          if [ "$HTTP_CODE" != "200" ]; then
               echo "History check failed with status $HTTP_CODE (ignoring for now, likely network issue)"
          else
               echo "✅ History check passed"
          fi

          # Verify Security Headers
          HEADERS=$(curl -s -I http://localhost:8099/health)
          if echo "$HEADERS" | grep -q "X-Frame-Options: DENY"; then
               echo "✅ X-Frame-Options header present"
          else
               echo "✗ Security headers missing"
               kill $SERVER_PID
               exit 1
          fi
          
          # Verify Dynamic Config (Enable Multiple Strategies)
          echo "Testing Multi-Strategy Config..."
          kill $SERVER_PID || true
          sleep 2
          
          ENABLED_STRATEGIES="ma_crossover,rsi_momentum" API_KEY=test-ci-key ./sherwood &
          TEST_PID=$!
          sleep 5
          
          RESPONSE=$(curl -s -H "X-Sherwood-API-Key: test-ci-key" http://localhost:8099/api/v1/strategies)
          if echo "$RESPONSE" | grep -q "ma_crossover" && echo "$RESPONSE" | grep -q "rsi_momentum"; then
            echo "✅ Multiple strategies verified"
          else
            echo "✗ Multiple strategies failed"
            kill $TEST_PID
            exit 1
          fi
          
          kill $TEST_PID || true
        } 2>&1 | tee api_config_output.txt

    - name: Generate Integration Summary
      if: always()
      shell: bash
      run: |
        echo "## Integration Test Summary" >> $GITHUB_STEP_SUMMARY
        
        process_log() {
          local file=$1
          local name=$2
          
          if [ -f "$file" ]; then
            PASS_COUNT=$(grep -E -i "✓|✅|passed|functional" "$file" | wc -l)
            
            # Failures that match 'ignoring' are counted as Ignored, not Failed
            FAIL_COUNT=$(grep -E -i "✗|failed" "$file" | grep -v -i "ignoring" | wc -l)
            IGNORED_COUNT=$(grep -E -i "failed" "$file" | grep -i "ignoring" | wc -l)
            
            TOTAL=$((PASS_COUNT + FAIL_COUNT + IGNORED_COUNT))
            
            echo "### $name" >> $GITHUB_STEP_SUMMARY
            echo "| Tests | Count |" >> $GITHUB_STEP_SUMMARY
            echo "| :--- | :---: |" >> $GITHUB_STEP_SUMMARY
            echo "| Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| Passed | $PASS_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | $FAIL_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| Ignored | $IGNORED_COUNT |" >> $GITHUB_STEP_SUMMARY
            
            if [ $FAIL_COUNT -gt 0 ]; then
               echo "" >> $GITHUB_STEP_SUMMARY
               echo "#### ❌ Failures" >> $GITHUB_STEP_SUMMARY
               echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
               grep -E -i "✗|failed" "$file" | grep -v -i "ignoring" >> $GITHUB_STEP_SUMMARY || true
               echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ $IGNORED_COUNT -gt 0 ]; then
               echo "" >> $GITHUB_STEP_SUMMARY
               echo "#### ⚠️ Ignored Issues" >> $GITHUB_STEP_SUMMARY
               echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
               grep -E -i "failed" "$file" | grep -i "ignoring" >> $GITHUB_STEP_SUMMARY || true
               echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### $name" >> $GITHUB_STEP_SUMMARY
            echo "No output log found." >> $GITHUB_STEP_SUMMARY
          fi
        }
        
        process_log "persistence_output.txt" "Order Persistence Tests"
        process_log "api_config_output.txt" "API & Configuration Tests"
