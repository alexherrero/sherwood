name: Backend Integration

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "**" ]

jobs:
  integration-test:
    name: Integration Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.7'

    - name: Build (Linux)
      if: matrix.os == 'ubuntu-latest'
      working-directory: ./
      run: go build -v -o sherwood ./backend/main.go

    - name: Build (Windows)
      if: matrix.os == 'windows-latest'
      working-directory: ./
      run: go build -v -o sherwood.exe ./backend/main.go

    - name: Run Integration Tests
      shell: bash
      working-directory: ./
      run: |
        # Start the backend in the background with API Key
        if [ "$RUNNER_OS" == "Windows" ]; then
          API_KEY=test-ci-key ./sherwood.exe &
        else
          API_KEY=test-ci-key ./sherwood &
        fi
        SERVER_PID=$!
        
        # Wait for server to start
        echo "Waiting for server to start..."
        sleep 5
        
        # Verify Health Endpoint
        echo "Verifying Health Endpoint..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8099/health)
        if [ "$HTTP_CODE" != "200" ]; then
          echo "Health check failed with status $HTTP_CODE"
          kill $SERVER_PID
          exit 1
        fi
        
        # Verify Status Endpoint (Should match 200 with key)
        echo "Verifying Status Endpoint with Key..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-Sherwood-API-Key: test-ci-key" http://localhost:8099/api/v1/status)
        if [ "$HTTP_CODE" != "200" ]; then
          echo "Status check failed with status $HTTP_CODE"
          kill $SERVER_PID
          exit 1
        fi

        # Verify Status Endpoint (Should match 401 without key)
        echo "Verifying Status Endpoint without Key..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8099/api/v1/status)
        if [ "$HTTP_CODE" != "401" ]; then
          echo "Security check failed. Expected 401 but got $HTTP_CODE"
          kill $SERVER_PID
          exit 1
        fi
        
        # Verify Strategies Endpoint
        echo "Verifying Strategies Endpoint..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-Sherwood-API-Key: test-ci-key" http://localhost:8099/api/v1/strategies)
        if [ "$HTTP_CODE" != "200" ]; then
          echo "Strategies check failed with status $HTTP_CODE"
          kill $SERVER_PID
          exit 1
        fi

        # Verify Execution Endpoints (Balance requires Key)
        echo "Verifying Balance Endpoint..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-Sherwood-API-Key: test-ci-key" http://localhost:8099/api/v1/execution/balance)
        if [ "$HTTP_CODE" != "200" ]; then
          echo "Balance check failed with status $HTTP_CODE"
          kill $SERVER_PID
          exit 1
        fi

        # Verify Historical Data Endpoint (Requires Key)
        echo "Verifying History Endpoint..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-Sherwood-API-Key: test-ci-key" "http://localhost:8099/api/v1/data/history?symbol=SPY&interval=1d")
        if [ "$HTTP_CODE" != "200" ]; then
             echo "History check failed with status $HTTP_CODE. (Could be network issue, ignoring for now but logging)"
             # Don't fail the build for external data dependency yet
        fi

        # Verify Engine Control (Start/Stop with Key)
        # Note: Engine auto-starts on application launch, so we first stop it
        echo "Verifying Engine Stop..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST -H "X-Sherwood-API-Key: test-ci-key" -d '{"confirm": true}' http://localhost:8099/api/v1/engine/stop)
        if [ "$HTTP_CODE" != "200" ]; then
          echo "Engine stop failed with status $HTTP_CODE"
          kill $SERVER_PID
          exit 1
        fi
        
        # Now start it again
        echo "Verifying Engine Start..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST -H "X-Sherwood-API-Key: test-ci-key" -d '{"confirm": true}' http://localhost:8099/api/v1/engine/start)
        if [ "$HTTP_CODE" != "200" ]; then
          echo "Engine start failed with status $HTTP_CODE"
          kill $SERVER_PID
          exit 1
        fi
        
        # Verify Config Validation Endpoint
        echo "Verifying Config Validation Endpoint..."
        RESPONSE=$(curl -s -H "X-Sherwood-API-Key: test-ci-key" http://localhost:8099/api/v1/config/validation)
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-Sherwood-API-Key: test-ci-key" http://localhost:8099/api/v1/config/validation)
        if [ "$HTTP_CODE" != "200" ]; then
          echo "Config validation check failed with status $HTTP_CODE"
          kill $SERVER_PID
          exit 1
        fi
        # Verify response contains expected fields
        if echo "$RESPONSE" | grep -q '"valid"' && echo "$RESPONSE" | grep -q '"provider"' && echo "$RESPONSE" | grep -q '"strategies"'; then
          echo "✓ Config validation endpoint returned valid response"
        else
          echo "✗ Config validation response missing required fields"
          echo "Response: $RESPONSE"
          kill $SERVER_PID
          exit 1
        fi

        # Verify Pagination and Filtering (Requires Key)
        echo "Verifying Pagination..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "X-Sherwood-API-Key: test-ci-key" "http://localhost:8099/api/v1/execution/orders?limit=1&page=1")
        if [ "$HTTP_CODE" != "200" ]; then
             echo "Pagination check failed with status $HTTP_CODE"
        fi

        # Verify Security Headers
        echo "Verifying Security Headers..."
        HEADERS=$(curl -s -I http://localhost:8099/health)
        if echo "$HEADERS" | grep -q "X-Frame-Options: DENY"; then
             echo "✓ X-Frame-Options header present"
        else
             echo "✗ Security headers missing"
             # Warn but don't fail yet? Or fail? Review said "Critical"
             # Let's fail as it is a requirement.
             kill $SERVER_PID
             exit 1
        fi

        # Verify Detailed Health Check
        echo "Verifying Enhanced Health Check..."
        HEALTH_RESP=$(curl -s http://localhost:8099/health)
        if echo "$HEALTH_RESP" | grep -q "\"checks\""; then
             echo "✓ Health check contains detailed checks"
        else
             echo "✗ Health check missing detailed checks: $HEALTH_RESP"
             kill $SERVER_PID
             exit 1
        fi

        # Verify Standardized Error Format
        echo "Verifying Error Format..."
        ERR_RESP=$(curl -s http://localhost:8099/api/v1/invalid-endpoint)
        # Should return 404 with JSON containing "code"
        if echo "$ERR_RESP" | grep -q "\"code\""; then
             echo "✓ Error response contains code field"
        else
             echo "✗ Error response missing code field: $ERR_RESP"
             kill $SERVER_PID
             exit 1
        fi

        echo "All integration tests passed!"
        
        # Cleanup
        kill $SERVER_PID

    - name: Test Dynamic Configuration
      shell: bash
      working-directory: ./
      run: |
        echo "========================================"
        echo "Testing Configuration           "
        echo "========================================"
        
        # Test 1: Multiple Strategies
        echo ""
        echo "Test 1: Multiple Strategies Enabled"
        if [ "$RUNNER_OS" == "Windows" ]; then
          ENABLED_STRATEGIES="ma_crossover,rsi_momentum" API_KEY=test-ci-key ./sherwood.exe &
        else
          ENABLED_STRATEGIES="ma_crossover,rsi_momentum" API_KEY=test-ci-key ./sherwood &
        fi
        TEST_PID=$!
        sleep 5
        
        # Verify strategies endpoint returns both strategies
        echo "Checking strategies endpoint..."
        RESPONSE=$(curl -s -H "X-Sherwood-API-Key: test-ci-key" http://localhost:8099/api/v1/strategies)
        if echo "$RESPONSE" | grep -q "ma_crossover" && echo "$RESPONSE" | grep -q "rsi_momentum"; then
          echo "✓ Multiple strategies test passed"
        else
          echo "✗ Multiple strategies test failed"
          echo "Response: $RESPONSE"
          kill $TEST_PID
          exit 1
        fi
        kill $TEST_PID
        sleep 2
        
        # Test 2: Invalid Strategy (Should Fail)
        echo ""
        echo "Test 2: Invalid Strategy Name (Should Fail)"
        if [ "$RUNNER_OS" == "Windows" ]; then
          ENABLED_STRATEGIES="invalid_strategy" API_KEY=test-ci-key timeout 5 ./sherwood.exe 2>&1 | tee test_output.txt &
        else
          ENABLED_STRATEGIES="invalid_strategy" API_KEY=test-ci-key timeout 5 ./sherwood 2>&1 | tee test_output.txt &
        fi
        TEST_PID=$!
        sleep 3
        
        # Check if process exited (it should fail immediately)
        if ps -p $TEST_PID > /dev/null 2>&1; then
          echo "✗ Invalid strategy test failed - process should have exited"
          kill $TEST_PID || true
          exit 1
        else
          echo "✓ Invalid strategy test passed - process failed as expected"
        fi
        
        # Test 3: Different Data Provider (Yahoo - default)
        echo ""
        echo "Test 3: Yahoo Data Provider (Default)"
        if [ "$RUNNER_OS" == "Windows" ]; then
          DATA_PROVIDER="yahoo" API_KEY=test-ci-key ./sherwood.exe &
        else
          DATA_PROVIDER="yahoo" API_KEY=test-ci-key ./sherwood &
        fi
        TEST_PID=$!
        sleep 5
        
        # Verify server started successfully
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8099/health)
        if [ "$HTTP_CODE" == "200" ]; then
          echo "✓ Yahoo provider test passed"
        else
          echo "✗ Yahoo provider test failed"
          kill $TEST_PID
          exit 1
        fi
        kill $TEST_PID
        sleep 2
        
        # Test 4: All Strategies Enabled
        echo ""
        echo "Test 4: All Strategies Enabled"
        if [ "$RUNNER_OS" == "Windows" ]; then
          ENABLED_STRATEGIES="ma_crossover,rsi_momentum,bb_mean_reversion,macd_trend_follower,nyc_close_open" API_KEY=test-ci-key ./sherwood.exe &
        else
          ENABLED_STRATEGIES="ma_crossover,rsi_momentum,bb_mean_reversion,macd_trend_follower,nyc_close_open" API_KEY=test-ci-key ./sherwood &
        fi
        TEST_PID=$!
        sleep 5
        
        # Verify all strategies are registered
        RESPONSE=$(curl -s -H "X-Sherwood-API-Key: test-ci-key" http://localhost:8099/api/v1/strategies)
        STRATEGY_COUNT=$(echo "$RESPONSE" | grep -o '"name":' | wc -l)
        if [ "$STRATEGY_COUNT" -ge 5 ]; then
          echo "✓ All strategies test passed (found $STRATEGY_COUNT strategies)"
        else
          echo "✗ All strategies test failed (expected 5, found $STRATEGY_COUNT)"
          echo "Response: $RESPONSE"
          kill $TEST_PID
          exit 1
        fi
        kill $TEST_PID
        sleep 2
        
        echo ""
        echo "========================================"
        echo "All Configuration Tests Passed!         "
        echo "========================================"
